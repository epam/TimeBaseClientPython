name: Build dxapi

on:
  workflow_dispatch:
  push:
    branches: [main, wip-workflow]
  pull_request:
    types: [opened, synchronize]
    branches:  [main, wip-workflow]
    
jobs:
#   Build-Dxapi-Linux:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Check out repository code
#         uses: actions/checkout@v2
#         with:
#           submodules: 'recursive'
#       - name: Build Dxapi
#         run: make -C ./dxapi/.
#         env: 
#           CC: clang
#       - name: Archive artifacts
#         uses: actions/upload-artifact@v2
#         with:
#           name: dxapi-linux
#           path: ./dxapi/bin/libdxapi-x64.a
            
  Build-Dxapi-MacOS:
    runs-on: macos-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Build Dxapi
        run: make -C ./dxapi/.
        env:
          CC: clang
          OS: MACOS
      - name: Archive artifacts
        uses: actions/upload-artifact@v2
        with:
          name: dxapi-macos
          path: |
            ./dxapi/bin/libdxapi-x64.a
            
#   Build-Dxapi-Windows:
#     runs-on: windows-latest
#     steps:
#     - name: Check out repository code
#       uses: actions/checkout@v2
#       with:
#         submodules: 'recursive'
#     - name: Use MSBuild
#       uses: microsoft/setup-msbuild@v1.0.2
#     - name: Build Solution
#       run: msbuild ./dxapi/dxapi.sln /p:configuration=release /p:platform=x64 /t:rebuild
#     - name: Build Debug Solution
#       run: msbuild ./dxapi/dxapi.sln /p:configuration=debug /p:platform=x64 /t:rebuild
#     - name: Archive artifacts
#       uses: actions/upload-artifact@v2
#       with:
#         name: dxapi-windows
#         path: ./dxapi/bin/dxapi-x64.lib

#   Build-Dxapi-Python38-Linux:
#     runs-on: ubuntu-latest
#     needs: [Build-Dxapi-Linux]
#     steps:
#       - name: Check out repository code
#         uses: actions/checkout@v2
#         with:
#           submodules: 'recursive'
#       - name: Download dxapi-linux artifacts
#         uses: actions/download-artifact@v2
#         with:
#           name: dxapi-linux
#           path: dxapi/bin
#       - name: install dev python
#         run: |
#           sudo apt-get update
#           sudo apt install -y python3.8-dev
#       - name: Build Dxapi
#         run: |
#           make -C .
#           cp ./dfp/lib/linux/64/libDecimalNative.so ./bin/release/linux/x64/py38/
#         env: 
#           CC: clang
#           PYTHON_VERSION: 38
#       - name: Archive artifacts
#         uses: actions/upload-artifact@v2
#         with:
#           name: dxapi-python38-linux
#           path: |
#             ./bin/release/__init__.py
#             ./bin/release/linux/x64/py38/_dxapi.so
#             ./bin/release/linux/x64/py38/libDecimalNative.so

#   Build-Dxapi-Python27-Linux:
#     runs-on: ubuntu-latest
#     needs: [Build-Dxapi-Linux]
#     steps:
#       - name: Check out repository code
#         uses: actions/checkout@v2
#         with:
#           submodules: 'recursive'
#       - name: Download dxapi-linux artifacts
#         uses: actions/download-artifact@v2
#         with:
#           name: dxapi-linux
#           path: dxapi/bin
#       - name: install dev python
#         run: |
#           sudo apt-get update
#           sudo apt install -y python2.7-dev
#       - name: Build Dxapi
#         run: |
#           make -C .
#           cp ./dfp/lib/linux/64/libDecimalNative.so ./bin/release/linux/x64/py27/
#         env: 
#           CC: clang
#           PYTHON_VERSION: 27
#       - name: Archive artifacts
#         uses: actions/upload-artifact@v2
#         with:
#           name: dxapi-python27-linux
#           path: |
#             ./bin/release/__init__.py
#             ./bin/release/linux/x64/py27/_dxapi.so
#             ./bin/release/linux/x64/py27/libDecimalNative.so
    
#   Build-Dxapi-Python36-Linux:
#     runs-on: ubuntu-latest
#     needs: [Build-Dxapi-Linux]
#     steps:
#       - name: Check out repository code
#         uses: actions/checkout@v2
#         with:
#           submodules: 'recursive'
#       - name: Download dxapi-linux artifacts
#         uses: actions/download-artifact@v2
#         with:
#           name: dxapi-linux
#           path: dxapi/bin
#       - name: install dev python
#         run: |
#           sudo apt-get update
#           sudo apt-get install -yq software-properties-common
#           sudo add-apt-repository ppa:deadsnakes/ppa 
#           sudo apt-get update
#           sudo apt-get install python3.6-dev
#       - name: Build Dxapi
#         run: |
#           make -C .
#           cp ./dfp/lib/linux/64/libDecimalNative.so ./bin/release/linux/x64/py36/
#         env: 
#           CC: clang
#           PYTHON_VERSION: 36
#       - name: Archive artifacts
#         uses: actions/upload-artifact@v2
#         with:
#           name: dxapi-python36-linux
#           path: |
#             ./bin/release/__init__.py
#             ./bin/release/linux/x64/py36/_dxapi.so
#             ./bin/release/linux/x64/py36/libDecimalNative.so

#   Build-Dxapi-Python37-Linux:
#     runs-on: ubuntu-latest
#     needs: [Build-Dxapi-Linux]
#     steps:
#       - name: Check out repository code
#         uses: actions/checkout@v2
#         with:
#           submodules: 'recursive'
#       - name: Download dxapi-linux artifacts
#         uses: actions/download-artifact@v2
#         with:
#           name: dxapi-linux
#           path: dxapi/bin
#       - name: install dev python
#         run: |
#           sudo apt-get update
#           sudo apt-get install -yq software-properties-common
#           sudo add-apt-repository ppa:deadsnakes/ppa 
#           sudo apt-get update
#           sudo apt-get install python3.7-dev
#       - name: Build Dxapi
#         run: |
#           make -C .
#           cp ./dfp/lib/linux/64/libDecimalNative.so ./bin/release/linux/x64/py37/
#         env: 
#           CC: clang
#           PYTHON_VERSION: 37
#       - name: Archive artifacts
#         uses: actions/upload-artifact@v2
#         with:
#           name: dxapi-python37-linux
#           path: |
#             ./bin/release/__init__.py
#             ./bin/release/linux/x64/py37/_dxapi.so
#             ./bin/release/linux/x64/py37/libDecimalNative.so

#   Build-Dxapi-Python38-Windows:
#     runs-on: windows-latest
#     needs: [Build-Dxapi-Windows]
#     steps:
#     - name: Check out repository code
#       uses: actions/checkout@v2
#       with:
#         submodules: 'recursive'
#     - name: Download dxapi-windows artifacts
#       uses: actions/download-artifact@v2
#       with:
#         name: dxapi-windows
#         path: dxapi/bin
#     - uses: actions/setup-python@v2
#       with:
#         python-version: '3.8'
#     - name: Use MSBuild
#       uses: microsoft/setup-msbuild@v1.0.2
#     - name: Build Solution
#       run: |
#         Expand-Archive -Path ./swigwin/swigwin-3.0.12.zip -DestinationPath ./swigwin -Force
#         $pwd = pwd
#         $Env:SWIG_HOME="$pwd/swigwin/swigwin-3.0.12"
#         $Env:SWIG_HOME
#         python --version
#         python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON38_HOME=python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON38_HOME
#         msbuild ./dxapi-python.sln /p:configuration=Release38 /p:platform=x64 /t:rebuild
#     - name: Archive artifacts
#       uses: actions/upload-artifact@v2
#       with:
#         name: dxapi-windows
#         path: |
#           ./bin/release/**/*

#   Build-Dxapi-Python27-Windows:
#     runs-on: windows-latest
#     needs: [Build-Dxapi-Windows]
#     steps:
#     - name: Check out repository code
#       uses: actions/checkout@v2
#       with:
#         submodules: 'recursive'
#     - name: Download dxapi-windows artifacts
#       uses: actions/download-artifact@v2
#       with:
#         name: dxapi-windows
#         path: dxapi/bin
#     - uses: actions/setup-python@v2
#       with:
#         python-version: '2.7'
#     - name: Use MSBuild
#       uses: microsoft/setup-msbuild@v1.0.2
#     - name: Build Solution
#       run: |
#         Expand-Archive -Path ./swigwin/swigwin-3.0.12.zip -DestinationPath ./swigwin -Force
#         $pwd = pwd
#         $Env:SWIG_HOME="$pwd/swigwin/swigwin-3.0.12"
#         $Env:SWIG_HOME
#         python --version
#         python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON27_HOME=python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON27_HOME
#         msbuild ./dxapi-python.sln /p:configuration=Release27 /p:platform=x64 /t:rebuild
#     - name: Archive artifacts
#       uses: actions/upload-artifact@v2
#       with:
#         name: dxapi-windows
#         path: |
#           ./bin/release/**/*

#   Build-Dxapi-Python36-Windows:
#     runs-on: windows-latest
#     needs: [Build-Dxapi-Windows]
#     steps:
#     - name: Check out repository code
#       uses: actions/checkout@v2
#       with:
#         submodules: 'recursive'
#     - name: Download dxapi-windows artifacts
#       uses: actions/download-artifact@v2
#       with:
#         name: dxapi-windows
#         path: dxapi/bin
#     - uses: actions/setup-python@v2
#       with:
#         python-version: '3.6'
#     - name: Use MSBuild
#       uses: microsoft/setup-msbuild@v1.0.2
#     - name: Build Solution
#       run: |
#         Expand-Archive -Path ./swigwin/swigwin-3.0.12.zip -DestinationPath ./swigwin -Force
#         $pwd = pwd
#         $Env:SWIG_HOME="$pwd/swigwin/swigwin-3.0.12"
#         $Env:SWIG_HOME
#         python --version
#         python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON36_HOME=python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON36_HOME
#         msbuild ./dxapi-python.sln /p:configuration=Release /p:platform=x64 /t:rebuild
#     - name: Archive artifacts
#       uses: actions/upload-artifact@v2
#       with:
#         name: dxapi-windows
#         path: |
#           ./bin/release/**/*
          
#   Build-Dxapi-Python37-Windows:
#     runs-on: windows-latest
#     needs: [Build-Dxapi-Windows]
#     steps:
#     - name: Check out repository code
#       uses: actions/checkout@v2
#       with:
#         submodules: 'recursive'
#     - name: Download dxapi-windows artifacts
#       uses: actions/download-artifact@v2
#       with:
#         name: dxapi-windows
#         path: dxapi/bin
#     - uses: actions/setup-python@v2
#       with:
#         python-version: '3.7'
#     - name: Use MSBuild
#       uses: microsoft/setup-msbuild@v1.0.2
#     - name: Build Solution
#       run: |
#         Expand-Archive -Path ./swigwin/swigwin-3.0.12.zip -DestinationPath ./swigwin -Force
#         $pwd = pwd
#         $Env:SWIG_HOME="$pwd/swigwin/swigwin-3.0.12"
#         $Env:SWIG_HOME
#         python --version
#         python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON37_HOME=python -c "import os, sys; print(os.path.dirname(sys.executable))"
#         $Env:PYTHON37_HOME
#         msbuild ./dxapi-python.sln /p:configuration=Release37 /p:platform=x64 /t:rebuild
#     - name: Archive artifacts
#       uses: actions/upload-artifact@v2
#       with:
#         name: dxapi-windows
#         path: |
#           ./bin/release/**/*

  Build-Dxapi-Python27-MacOS:
    runs-on: macos-latest
    needs: [Build-Dxapi-MacOS]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Download dxapi-macos artifacts
        uses: actions/download-artifact@v2
        with:
          name: dxapi-macos
          path: dxapi/bin
      - uses: actions/setup-python@v2
        with:
          python-version: '2.7'
      - name: Install SWIG
        run: |
          curl -OL https://sourceforge.net/projects/swig/files/swig/swig-3.0.12/swig-3.0.12.tar.gz
          tar -xzvf swig-3.0.12.tar.gz
          cd swig-3.0.12
          ./configure
          make
          make install
      - name: Build Dxapi
        run: |
           make -C .
           cp ./dfp/lib/osx/64/libDecimalNative.dylib ./bin/release/darwin/x64/py27/
        env:
          CC: clang
          OS: MACOS
          PYTHON_VERSION: 27
      - name: Archive artifacts
        uses: actions/upload-artifact@v2
        with:
          name: dxapi-macos
          path: |
            ./bin/release/__init__.py
            ./bin/release/osx/x64/py27/_dxapi.so
            ./bin/release/osx/x64/py27/libDecimalNative.dylib
