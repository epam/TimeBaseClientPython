name: Build dxapi

on:
  workflow_dispatch:
  push:
    branches: [main, wip-workflow]
  pull_request:
    types: [opened, synchronize]
    branches:  [main, wip-workflow]
    
jobs:
  build-dxapi:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: macos-latest
            env_os: MACOS
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Build Dxapi
        run: make -C ./dxapi/.
        env: 
          CC: clang
          OS: ${{ matrix.env_os }}
      - name: Archive artifacts
        uses: actions/upload-artifact@v2
        with:
          name: dxapi-${{ matrix.os }}
          path: ./dxapi/bin/libdxapi-x64.a
          
#  build-windows-dxapi:
#    runs-on: windows-2019
#    steps:
#    - name: Check out repository code
#      uses: actions/checkout@v2
#      with:
#        submodules: 'recursive'
#    - name: Use MSBuild
#      uses: microsoft/setup-msbuild@v1.1
#    - name: Build Solution
#      run: msbuild ./dxapi/dxapi.sln /p:configuration=release /p:platform=x64 /t:rebuild
#    - name: Archive artifacts
#      uses: actions/upload-artifact@v2
#      with:
#        name: dxapi-windows
#        path: ./dxapi/bin/dxapi-x64.lib
        
#  build-dxapi-python-linux:
#    runs-on: ubuntu-latest
#    needs: [build-dxapi]
#    strategy:
#      matrix:
#        py: ['3.6', '3.7', '3.8', '3.9']
#        include:
#          - py: '3.6'
#            py_env: '36'
#          - py: '3.7'
#            py_env: '37'
#          - py: '3.8'
#            py_env: '38'
#          - py: '3.9'
#            py_env: '39'
#    steps:
#      - name: Check out repository code
#        uses: actions/checkout@v2
#        with:
#          submodules: 'recursive'
#      - name: Download dxapi-linux artifacts
#        uses: actions/download-artifact@v2
#        with:
#          name: dxapi-ubuntu-latest
#          path: dxapi/bin
#      - name: install dev python 3.8, 3.9, 3.10
#        if: ${{ matrix.py == '3.8' || matrix.py == '3.9' || matrix.py == '3.10' }}
#        run: |
#          sudo apt-get update
#          sudo apt install -y python${{ matrix.py }}-dev
#      - name: install dev python 3.6 & 3.7
#        if: ${{ matrix.py == '3.6' || matrix.py == '3.7' }}
#        run: |
#          sudo apt-get update
#          sudo apt-get install -yq software-properties-common
#          sudo add-apt-repository ppa:deadsnakes/ppa
#          sudo apt-get update
#          sudo apt-get install python${{ matrix.py }}-dev
#      - name: Build Dxapi
#        run: |
#          make -C .
#          cp ./dfp/lib/linux/64/libDecimalNative.so ./bin/release/linux/x64/py${{ matrix.py_env }}/
#        env:
#          CC: clang
#          PYTHON_VERSION: ${{ matrix.py_env }}
#      - name: Archive artifacts
#        uses: actions/upload-artifact@v2
#        with:
#          name: dxapi-python-linux
#          path: |
#            ./bin/release/__init__.py
#            ./bin/release/linux/x64/py${{ matrix.py_env }}/_dxapi.so
#            ./bin/release/linux/x64/py${{ matrix.py_env }}/libDecimalNative.so

#  build-dxapi-python-windows:
#    runs-on: windows-2019
#    needs: [build-windows-dxapi]
#    strategy:
#      matrix:
#        py: ['3.6', '3.7', '3.8', '3.9', '3.10']
#        include:
#          - py: '3.6'
#            py_env: '36'
#          - py: '3.7'
#            py_env: '37'
#          - py: '3.8'
#            py_env: '38'
#          - py: '3.9'
#            py_env: '39'
#          - py: '3.10'
#            py_env: '310'
#    steps:
#    - name: Check out repository code
#      uses: actions/checkout@v2
#      with:
#        submodules: 'recursive'
#    - name: Download dxapi-windows artifacts
#      uses: actions/download-artifact@v2
#      with:
#        name: dxapi-windows
#        path: dxapi/bin
#    - uses: actions/setup-python@v2
#      with:
#        python-version: '${{ matrix.py }}'
#    - name: Use MSBuild
#      uses: microsoft/setup-msbuild@v1.1
#    - name: Build Solution
#      run: |
#        Expand-Archive -Path ./swigwin/swigwin-3.0.12.zip -DestinationPath ./swigwin -Force
#        $pwd = pwd
#        $Env:SWIG_HOME="$pwd/swigwin/swigwin-3.0.12"
#        $Env:SWIG_HOME
#        python --version
#        python -c "import os, sys; print(os.path.dirname(sys.executable))"
#        $Env:PYTHON${{ matrix.py_env }}_HOME=python -c "import os, sys; print(os.path.dirname(sys.executable))"
#        $Env:PYTHON${{ matrix.py_env }}_HOME
#        msbuild ./dxapi-python.sln /p:configuration=Release${{ matrix.py_env }} /p:platform=x64 /t:rebuild
#    - name: Archive artifacts
#      uses: actions/upload-artifact@v2
#      with:
#        name: dxapi-python-windows
#        path: |
#          ./bin/release/__init__.py
#          ./bin/release/windows/x64/py${{ matrix.py_env }}/_dxapi.pyd
#          ./bin/release/windows/x64/py${{ matrix.py_env }}/DecimalNative.dll

  build-dxapi-python-macos:
    runs-on: macos-latest
    needs: [build-dxapi]
    strategy:
      matrix:
        py: ['3.6', '3.7', '3.8', '3.9']
        include:
          - py: '3.6'
            py_env: '36'
            py_v: '3.6.15'
          - py: '3.7'
            py_env: '37'
            py_v: '3.7.12'
          - py: '3.8'
            py_env: '38'
            py_v: '3.8.12'
          - py: '3.9'
            py_env: '39'
            py_v: '3.9.10'
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Download dxapi-macos artifacts
        uses: actions/download-artifact@v2
        with:
          name: dxapi-macos-latest
          path: dxapi/bin
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.py }}
      - name: Install SWIG
        run: |
          curl -OL https://sourceforge.net/projects/swig/files/swig/swig-3.0.12/swig-3.0.12.tar.gz
          tar -xzvf swig-3.0.12.tar.gz
          cd swig-3.0.12
          ./configure
          make
          make install
      - name: Build Dxapi
        run: |
          python -c "import os, sys; print(os.path.dirname(sys.executable))"
          make -C .
          cp ./dfp/lib/osx/64/libDecimalNative.dylib ./bin/release/darwin/x64/py${{ matrix.py_env }}/
        env:
          CC: clang
          OS: MACOS
          PYTHON_VERSION: ${{ matrix.py_env }}
      - name: Archive artifacts
        uses: actions/upload-artifact@v2
        with:
          name: dxapi-python-macos
          path: |
            ./bin/release/__init__.py
            ./bin/release/darwin/x64/py${{ matrix.py_env }}/_dxapi.so
            ./bin/release/darwin/x64/py${{ matrix.py_env }}/libDecimalNative.dylib
